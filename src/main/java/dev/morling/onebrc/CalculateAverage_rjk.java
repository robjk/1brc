package dev.morling.onebrc;

import java.io.IOException;
import java.lang.foreign.Arena;
import java.lang.foreign.MemorySegment;
import java.lang.foreign.ValueLayout;
import java.nio.channels.FileChannel;
import java.nio.charset.StandardCharsets;
import java.nio.file.Path;
import java.nio.file.StandardOpenOption;
import java.util.*;
import java.util.concurrent.*;
import java.util.stream.Collectors;

import static java.lang.foreign.ValueLayout.JAVA_BYTE;
import static java.lang.foreign.ValueLayout.JAVA_LONG;
import static java.nio.ByteOrder.BIG_ENDIAN;

/*
    Development notes

    Theory: MemorySegments should allow us to mmap and parse the file no worse than baseline, open up further optimisations
        - results: marginally faster on a noisy windows machine - profiling highlights the following CPU sinks:
            - MemorySegment to array hit for city name byte[]
            - MemorySegment.get calls to read a byte from the mmap file
            - new String as the precursor to Double.ParseDouble
            - Double.parseDouble
            - HashMap.contains calls (equals)
            - HashMap.get calls (equals)
        - highest cost activities
            1. Double.parseDouble + reading from the MemorySegment -> String
            2. reading the city into an array
            3. HashMap get + HashMap contains
        - garbage creation
            - #1 Double.parseDouble
            - MappedMemorySegment.asSlice / toArray [cityString into template]
            - MappedMemorySegment.asSlice / toArray / toString (parseDouble precursor)

    Second iteration: Custom double parsing
        * remove Double.parse entirely (well, edge-case around very last measurement in the file and bounds)

        Costly activities
            1. turning the city name bytes into an array and generating the hash code is **costly**
            2. HashMap get/contains also costly
            3. reading the city bytes to find the ';'

    Third iteration:
        * incremental hash calculation
        * don't create an array of bytes from the memory segment each time, directly populate an existing template
        * better use of template via breaking encapsulation
        * tweaking measurement conversion

        Costly activities:
            1. HashMap.get (and the StationStat equals method)
            2. #extractMeasurement
            3. HashMap.containsKey (see 1)
            4. MemorySegment.get (byte, when reading the city name)

    Note: measurements.txt was recreated after Third iteration, making comparision with future iterations questionnable.
    However, moving to multiple-threads will be a step change in performance.

    Fourth iteration:
        In iteration 3, ~43% time spent on the HashMap get/contains calls - reluctant to implement a new one right now but it's an obvious win

        Time to throw more threads at the work, this will make a significant change

            * Split the work across multiple threads by giving each of them a segment in the file to process, then collate
                the results together at the end.  This will require logic to identify the location of a nearby '\n' given we
                won't know where they are when we pick a starting offset for a thread

        Notes on implementation
            * start up time and shut down time are not being measured, so currently comparable vs previous
                implementations of my own but not anyone else
            * Stricter adherence to the competition rules (can be configured to support max number of stations, assumes max station name length)
            * As described above, file mmapped into the global arean (avoids memory barriers enforced by shared)
            * 8 threads (as per rules) each given a starting offest at n/8 bytes into the memory region
            * threads check that the previous byte is not a '\n' (= they are at a valid start position)
                if they are not at a valid start position walk forward until next '\n' is found
            * threads process seqeuentially, and all but the last thread are allowed to slightly overrun to complete a
                partially processed measurement (the thread dealing with the next segment will have skipped it)
            * debug validity checks added, will be removed when chasing the smaller gains
            * oddly, introducing a call to system.out.printf (or println) in a non-critical setup loop consistently
                improves the performance.  profiling suggests that the hasmap getNode performs worse (amongst other)
                without it.  JITWatch didn't immediately through up anything so this is deferred for a later
                optimisation phase.  For now the hack is *not* included as an official result

        Profiling notes
            1. HashMap.get still hurts
            2. extractMeasurement, half the time is reading the long from the memorysegment, remainder needs a closer look
            3. reading the individual bytes of the station name

            for 2 above, we're suffering an endian conversion, this can be fixed
            also, JITWatch is highlighiting large methods impacting inlinining decisions, it may be fruitful to look at
            that

 */

public class CalculateAverage_rjk {

    public static final int THREAD_COUNT = 8;
    public static final int NUMBER_OF_STATIONS = 413;
    private static final boolean DEBUG = false;


    private static final String GUNNAR_OUTPUT = "{Abha=-29.8/18.0/68.1, Abidjan=-27.7/26.0/72.8, Abéché=-18.9/29.4/77.9, Accra=-20.4/26.4/77.9, Addis Ababa=-36.7/16.0/64.6, Adelaide=-30.6/17.3/65.3, Aden=-19.7/29.1/76.9, Ahvaz=-25.9/25.4/72.4, Albuquerque=-39.0/14.0/61.3, Alexandra=-36.6/11.0/61.1, Alexandria=-28.8/20.0/69.0, Algiers=-28.8/18.2/67.8, Alice Springs=-27.1/21.0/67.3, Almaty=-41.9/10.0/62.2, Amsterdam=-40.9/10.2/59.2, Anadyr=-57.8/-6.9/48.1, Anchorage=-46.7/2.8/52.4, Andorra la Vella=-41.3/9.8/60.4, Ankara=-39.3/12.0/62.3, Antananarivo=-33.9/17.9/68.6, Antsiranana=-26.0/25.2/74.1, Arkhangelsk=-49.1/1.3/51.9, Ashgabat=-31.5/17.1/66.2, Asmara=-31.4/15.6/69.0, Assab=-19.9/30.5/83.5, Astana=-47.2/3.5/55.1, Athens=-31.2/19.2/66.8, Atlanta=-29.3/17.0/65.2, Auckland=-32.3/15.2/63.7, Austin=-28.7/20.7/69.4, Baghdad=-35.5/22.8/77.3, Baguio=-30.5/19.5/68.8, Baku=-34.1/15.1/65.9, Baltimore=-34.5/13.1/63.6, Bamako=-23.9/27.8/81.4, Bangkok=-23.7/28.6/77.0, Bangui=-24.2/26.0/79.3, Banjul=-23.1/26.0/77.9, Barcelona=-31.0/18.2/67.4, Bata=-25.1/25.1/75.2, Batumi=-32.9/14.0/64.8, Beijing=-40.0/12.9/60.1, Beirut=-28.3/20.9/72.3, Belgrade=-41.8/12.5/67.4, Belize City=-23.8/26.7/77.5, Benghazi=-32.4/19.9/72.6, Bergen=-42.9/7.7/55.0, Berlin=-39.2/10.3/59.7, Bilbao=-36.1/14.7/61.8, Birao=-24.7/26.5/78.2, Bishkek=-43.8/11.3/62.2, Bissau=-20.8/27.0/74.1, Blantyre=-33.6/22.2/74.6, Bloemfontein=-35.3/15.6/63.2, Boise=-37.3/11.4/60.3, Bordeaux=-35.5/14.2/63.6, Bosaso=-23.9/30.0/82.2, Boston=-42.2/10.9/59.1, Bouaké=-24.7/26.0/74.8, Bratislava=-37.0/10.5/60.7, Brazzaville=-25.5/25.0/75.4, Bridgetown=-23.1/27.0/73.5, Brisbane=-28.6/21.4/73.5, Brussels=-38.0/10.5/61.6, Bucharest=-40.7/10.8/61.3, Budapest=-40.4/11.3/64.6, Bujumbura=-26.1/23.8/78.1, Bulawayo=-37.3/18.9/70.3, Burnie=-40.0/13.1/58.7, Busan=-37.2/15.0/65.5, Cabo San Lucas=-25.4/23.9/72.1, Cairns=-24.4/25.0/71.7, Cairo=-31.9/21.4/70.5, Calgary=-43.5/4.4/54.9, Canberra=-36.0/13.1/69.1, Cape Town=-33.4/16.2/65.5, Changsha=-28.5/17.4/67.3, Charlotte=-32.8/16.1/68.0, Chiang Mai=-26.3/25.8/75.6, Chicago=-47.0/9.8/61.2, Chihuahua=-31.5/18.6/67.4, Chittagong=-25.0/25.9/82.9, Chișinău=-38.3/10.2/58.6, Chongqing=-30.4/18.6/70.2, Christchurch=-45.1/12.2/62.4, City of San Marino=-36.8/11.8/61.0, Colombo=-19.8/27.4/76.8, Columbus=-37.3/11.7/61.4, Conakry=-21.9/26.4/87.1, Copenhagen=-43.9/9.1/58.4, Cotonou=-22.3/27.2/77.6, Cracow=-39.6/9.3/61.2, Da Lat=-31.1/17.9/71.5, Da Nang=-21.7/25.8/72.8, Dakar=-24.4/24.0/71.4, Dallas=-34.6/19.0/69.5, Damascus=-33.3/17.0/68.3, Dampier=-26.8/26.4/75.6, Dar es Salaam=-29.2/25.8/73.4, Darwin=-19.7/27.6/76.0, Denpasar=-27.7/23.7/77.4, Denver=-40.9/10.4/59.0, Detroit=-39.1/10.0/58.1, Dhaka=-23.0/25.9/74.7, Dikson=-59.6/-11.1/38.6, Dili=-26.0/26.6/74.5, Djibouti=-18.4/29.9/77.0, Dodoma=-26.4/22.7/73.7, Dolisie=-22.9/24.0/76.8, Douala=-23.0/26.7/77.2, Dubai=-19.4/26.9/76.1, Dublin=-39.1/9.8/61.4, Dunedin=-37.9/11.1/60.5, Durban=-28.3/20.6/76.9, Dushanbe=-41.0/14.7/68.5, Edinburgh=-42.9/9.3/62.6, Edmonton=-42.8/4.2/52.7, El Paso=-30.9/18.1/66.8, Entebbe=-27.8/21.0/71.4, Erbil=-31.9/19.5/68.4, Erzurum=-45.5/5.1/55.8, Fairbanks=-56.3/-2.3/46.5, Fianarantsoa=-28.7/17.9/70.1, Flores,  Petén=-21.7/26.4/78.4, Frankfurt=-39.2/10.6/60.8, Fresno=-33.9/17.9/77.2, Fukuoka=-32.7/17.0/68.9, Gaborone=-27.6/21.0/71.2, Gabès=-31.3/19.5/67.0, Gagnoa=-23.2/26.0/75.2, Gangtok=-39.3/15.2/68.5, Garissa=-17.7/29.3/81.4, Garoua=-21.2/28.3/80.3, George Town=-20.6/27.9/77.0, Ghanzi=-25.5/21.4/68.7, Gjoa Haven=-66.6/-14.4/37.0, Guadalajara=-29.6/20.9/68.6, Guangzhou=-30.9/22.4/70.9, Guatemala City=-28.5/20.4/69.1, Halifax=-39.5/7.5/57.7, Hamburg=-40.1/9.7/59.8, Hamilton=-45.6/13.8/66.8, Hanga Roa=-29.2/20.5/69.4, Hanoi=-25.9/23.6/75.3, Harare=-30.2/18.4/73.6, Harbin=-45.7/5.0/54.7, Hargeisa=-27.0/21.7/72.3, Hat Yai=-26.4/27.0/77.9, Havana=-22.7/25.2/77.3, Helsinki=-42.6/5.9/58.7, Heraklion=-34.5/18.9/69.0, Hiroshima=-32.3/16.3/68.6, Ho Chi Minh City=-22.0/27.4/84.1, Hobart=-35.4/12.7/62.0, Hong Kong=-23.6/23.3/74.4, Honiara=-20.8/26.5/77.3, Honolulu=-22.7/25.4/75.0, Houston=-29.7/20.8/76.2, Ifrane=-36.6/11.4/63.9, Indianapolis=-41.1/11.8/60.4, Iqaluit=-59.5/-9.3/43.1, Irkutsk=-48.0/1.0/51.8, Istanbul=-40.8/13.9/65.0, Jacksonville=-35.4/20.3/68.9, Jakarta=-25.4/26.7/75.5, Jayapura=-19.6/27.0/75.4, Jerusalem=-29.2/18.3/67.6, Johannesburg=-33.8/15.5/68.7, Jos=-26.1/22.8/73.1, Juba=-21.6/27.8/82.3, Kabul=-36.4/12.1/66.1, Kampala=-29.2/20.0/71.2, Kandi=-20.3/27.7/78.8, Kankan=-22.3/26.5/82.9, Kano=-28.7/26.4/77.3, Kansas City=-36.1/12.5/60.0, Karachi=-23.5/26.0/76.6, Karonga=-25.7/24.4/73.0, Kathmandu=-30.3/18.3/66.7, Khartoum=-18.7/29.9/80.0, Kingston=-20.4/27.4/77.4, Kinshasa=-21.4/25.3/73.1, Kolkata=-22.1/26.7/75.2, Kuala Lumpur=-20.5/27.3/76.1, Kumasi=-22.7/26.0/75.4, Kunming=-31.8/15.7/67.8, Kuopio=-47.6/3.4/53.2, Kuwait City=-23.4/25.7/79.2, Kyiv=-42.7/8.4/58.3, Kyoto=-34.4/15.8/62.5, La Ceiba=-26.4/26.2/77.2, La Paz=-31.9/23.7/72.3, Lagos=-21.7/26.8/77.7, Lahore=-31.9/24.3/73.5, Lake Havasu City=-31.7/23.7/74.1, Lake Tekapo=-37.6/8.7/59.6, Las Palmas de Gran Canaria=-28.3/21.2/68.3, Las Vegas=-28.6/20.3/70.1, Launceston=-40.4/13.1/60.1, Lhasa=-42.0/7.6/64.0, Libreville=-22.0/25.9/71.4, Lisbon=-33.9/17.5/64.0, Livingstone=-26.2/21.8/73.9, Ljubljana=-39.3/10.9/59.0, Lodwar=-17.6/29.3/79.0, Lomé=-24.3/26.9/75.9, London=-46.5/11.3/60.2, Los Angeles=-35.9/18.6/67.1, Louisville=-39.3/13.9/63.2, Luanda=-23.3/25.8/77.1, Lubumbashi=-30.5/20.8/69.7, Lusaka=-28.6/19.9/74.8, Luxembourg City=-43.2/9.3/57.2, Lviv=-48.6/7.8/57.6, Lyon=-43.9/12.5/60.9, Madrid=-37.2/15.0/65.5, Mahajanga=-25.4/26.3/77.6, Makassar=-27.5/26.7/78.6, Makurdi=-21.2/26.0/73.7, Malabo=-21.9/26.3/79.9, Malé=-24.8/28.0/75.9, Managua=-22.4/27.3/75.8, Manama=-23.9/26.5/79.6, Mandalay=-24.8/28.0/79.3, Mango=-21.0/28.1/79.0, Manila=-26.1/28.4/83.6, Maputo=-28.5/22.8/73.8, Marrakesh=-31.4/19.6/79.7, Marseille=-39.5/15.8/64.1, Maun=-28.3/22.4/70.6, Medan=-22.7/26.5/80.3, Mek'ele=-27.9/22.7/71.0, Melbourne=-39.0/15.1/63.7, Memphis=-33.5/17.2/66.5, Mexicali=-26.3/23.1/76.8, Mexico City=-32.8/17.5/67.0, Miami=-21.3/24.9/77.9, Milan=-42.4/13.0/63.2, Milwaukee=-39.5/8.9/57.2, Minneapolis=-46.2/7.8/59.7, Minsk=-47.7/6.7/55.8, Mogadishu=-24.2/27.1/81.7, Mombasa=-22.6/26.3/75.6, Monaco=-32.1/16.4/65.8, Moncton=-45.5/6.1/57.4, Monterrey=-27.5/22.3/75.5, Montreal=-42.5/6.8/58.2, Moscow=-43.7/5.8/55.8, Mumbai=-25.7/27.1/76.0, Murmansk=-50.0/0.6/47.4, Muscat=-23.0/28.0/76.3, Mzuzu=-31.0/17.7/67.0, N'Djamena=-20.4/28.3/83.6, Naha=-26.1/23.1/74.6, Nairobi=-32.7/17.8/68.0, Nakhon Ratchasima=-24.1/27.3/80.7, Napier=-36.4/14.6/62.3, Napoli=-32.0/15.9/64.4, Nashville=-40.3/15.4/67.0, Nassau=-28.1/24.6/78.0, Ndola=-30.0/20.3/69.5, New Delhi=-28.6/25.0/76.0, New Orleans=-29.2/20.7/76.3, New York City=-38.8/12.9/61.3, Ngaoundéré=-31.1/22.0/70.4, Niamey=-20.4/29.3/82.8, Nicosia=-33.8/19.7/67.6, Niigata=-35.7/13.9/62.1, Nouadhibou=-28.3/21.3/73.7, Nouakchott=-27.0/25.7/75.5, Novosibirsk=-52.6/1.7/56.0, Nuuk=-49.9/-1.4/50.8, Odesa=-37.3/10.7/57.9, Odienné=-23.4/26.0/77.4, Oklahoma City=-34.8/15.9/64.3, Omaha=-39.3/10.6/62.7, Oranjestad=-19.1/28.1/78.2, Oslo=-46.1/5.7/58.9, Ottawa=-46.7/6.6/55.1, Ouagadougou=-24.3/28.3/78.4, Ouahigouya=-21.5/28.6/76.1, Ouarzazate=-31.5/18.9/71.7, Oulu=-48.9/2.7/52.5, Palembang=-23.5/27.3/80.8, Palermo=-27.9/18.5/70.2, Palm Springs=-25.3/24.5/78.3, Palmerston North=-36.0/13.2/64.3, Panama City=-22.4/28.0/76.3, Parakou=-28.1/26.8/76.9, Paris=-39.2/12.3/65.9, Perth=-29.8/18.7/66.3, Petropavlovsk-Kamchatsky=-49.8/1.9/49.3, Philadelphia=-35.6/13.2/60.4, Phnom Penh=-22.5/28.3/81.6, Phoenix=-24.0/23.9/74.1, Pittsburgh=-37.5/10.8/59.8, Podgorica=-35.9/15.3/65.4, Pointe-Noire=-22.4/26.1/72.1, Pontianak=-29.8/27.7/79.8, Port Moresby=-22.4/26.9/72.7, Port Sudan=-20.3/28.4/79.8, Port Vila=-22.5/24.3/75.1, Port-Gentil=-26.9/26.0/77.7, Portland (OR)=-39.0/12.4/62.6, Porto=-31.2/15.7/63.2, Prague=-42.6/8.4/61.0, Praia=-26.1/24.4/70.9, Pretoria=-28.9/18.2/67.5, Pyongyang=-38.2/10.8/64.0, Rabat=-30.0/17.2/64.5, Rangpur=-24.2/24.4/72.2, Reggane=-27.1/28.3/75.0, Reykjavík=-42.8/4.3/52.5, Riga=-43.5/6.2/54.1, Riyadh=-24.1/26.0/75.3, Rome=-37.1/15.2/62.9, Roseau=-24.4/26.2/76.3, Rostov-on-Don=-40.2/9.9/60.3, Sacramento=-31.8/16.3/65.6, Saint Petersburg=-45.4/5.8/57.1, Saint-Pierre=-45.6/5.7/55.5, Salt Lake City=-39.4/11.6/67.6, San Antonio=-30.4/20.8/68.8, San Diego=-33.7/17.8/66.6, San Francisco=-34.3/14.6/65.1, San Jose=-30.7/16.4/66.5, San José=-28.9/22.6/74.3, San Juan=-21.4/27.2/77.6, San Salvador=-27.6/23.1/78.6, Sana'a=-27.8/20.0/67.8, Santo Domingo=-23.3/25.9/78.6, Sapporo=-45.2/8.9/64.6, Sarajevo=-37.6/10.1/56.9, Saskatoon=-52.4/3.3/50.7, Seattle=-42.5/11.3/64.1, Seoul=-35.3/12.5/66.7, Seville=-30.9/19.2/76.7, Shanghai=-38.5/16.7/68.0, Singapore=-27.1/27.0/79.2, Skopje=-33.8/12.4/62.7, Sochi=-40.5/14.2/69.1, Sofia=-38.7/10.6/61.6, Sokoto=-25.7/28.0/74.4, Split=-42.3/16.1/64.1, St. John's=-44.9/5.0/56.8, St. Louis=-34.5/13.9/66.1, Stockholm=-44.2/6.6/54.5, Surabaya=-26.5/27.1/75.0, Suva=-25.0/25.6/74.9, Suwałki=-41.4/7.2/59.2, Sydney=-34.8/17.7/73.4, Ségou=-26.1/28.0/79.4, Tabora=-26.4/23.0/72.9, Tabriz=-37.3/12.6/62.8, Taipei=-29.6/23.0/70.7, Tallinn=-42.8/6.4/55.2, Tamale=-22.3/27.9/77.4, Tamanrasset=-32.1/21.7/69.8, Tampa=-28.8/22.9/74.5, Tashkent=-32.0/14.8/62.8, Tauranga=-32.8/14.8/64.1, Tbilisi=-38.0/12.9/62.7, Tegucigalpa=-27.7/21.7/71.3, Tehran=-32.5/17.0/66.5, Tel Aviv=-28.6/20.0/70.8, Thessaloniki=-34.9/16.0/63.2, Thiès=-24.3/24.0/77.9, Tijuana=-31.1/17.8/69.7, Timbuktu=-23.2/28.0/75.3, Tirana=-35.4/15.2/65.3, Toamasina=-29.2/23.4/75.4, Tokyo=-47.1/15.4/64.6, Toliara=-26.4/24.1/75.2, Toluca=-37.1/12.4/64.8, Toronto=-41.4/9.4/57.6, Tripoli=-29.7/20.0/66.6, Tromsø=-51.2/2.9/51.0, Tucson=-33.3/20.9/73.4, Tunis=-30.7/18.4/72.5, Ulaanbaatar=-49.7/-0.4/58.7, Upington=-30.1/20.4/71.1, Vaduz=-38.7/10.1/59.5, Valencia=-35.0/18.3/69.6, Valletta=-31.1/18.8/68.9, Vancouver=-39.9/10.4/58.8, Veracruz=-23.9/25.4/76.3, Vienna=-36.8/10.4/59.4, Vientiane=-29.9/25.9/77.5, Villahermosa=-29.6/27.1/79.6, Vilnius=-41.5/6.0/56.4, Virginia Beach=-35.5/15.8/65.8, Vladivostok=-43.0/4.9/51.9, Warsaw=-38.5/8.5/59.4, Washington, D.C.=-34.6/14.6/68.6, Wau=-22.2/27.8/75.2, Wellington=-35.7/12.9/59.8, Whitehorse=-51.7/-0.1/50.9, Wichita=-34.9/13.9/61.7, Willemstad=-26.6/28.0/83.4, Winnipeg=-44.2/3.0/55.5, Wrocław=-37.0/9.6/58.6, Xi'an=-38.1/14.1/62.2, Yakutsk=-57.3/-8.8/40.2, Yangon=-24.8/27.5/77.8, Yaoundé=-26.3/23.8/75.2, Yellowknife=-54.8/-4.3/50.3, Yerevan=-34.7/12.4/58.9, Yinchuan=-46.5/9.0/56.4, Zagreb=-40.3/10.7/60.7, Zanzibar City=-27.1/26.0/76.0, Zürich=-41.7/9.3/58.4, Ürümqi=-39.1/7.4/56.6, İzmir=-31.8/17.9/73.0}";
    private static final String DEBUG_OUTPUT = "{Abha=-29.800000/18.000000/68.100000/43569470.700000/2420932, Abidjan=-27.700000/26.000000/72.800000/62903273.800000/2419431, Abéché=-18.900000/29.400000/77.900000/71213848.700000/2421345, Accra=-20.400000/26.400000/77.900000/63977543.300000/2423554, Addis Ababa=-36.700000/16.000000/64.600000/38743678.800000/2421245, Adelaide=-30.600000/17.300000/65.300000/41846405.400000/2420293, Aden=-19.700000/29.100000/76.900000/70498032.900000/2422318, Ahvaz=-25.900000/25.400000/72.400000/61460642.500000/2420278, Albuquerque=-39.000000/14.000000/61.300000/33919460.900000/2422773, Alexandra=-36.600000/11.000000/61.100000/26625685.600000/2421502, Alexandria=-28.800000/20.000000/69.000000/48422814.200000/2420761, Algiers=-28.800000/18.200000/67.800000/44117892.300000/2423861, Alice Springs=-27.100000/21.000000/67.300000/50851519.200000/2421492, Almaty=-41.900000/10.000000/62.200000/24191240.400000/2418074, Amsterdam=-40.900000/10.200000/59.200000/24682173.400000/2421109, Anadyr=-57.800000/-6.900000/48.100000/-16718373.400000/2421642, Anchorage=-46.700000/2.800000/52.400000/6759193.000000/2424631, Andorra la Vella=-41.300000/9.800000/60.400000/23753456.300000/2422386, Ankara=-39.300000/12.000000/62.300000/29050192.000000/2420959, Antananarivo=-33.900000/17.900000/68.600000/43330199.200000/2420243, Antsiranana=-26.000000/25.200000/74.100000/61058022.200000/2422384, Arkhangelsk=-49.100000/1.300000/51.900000/3122363.400000/2420011, Ashgabat=-31.500000/17.100000/66.200000/41461340.300000/2423751, Asmara=-31.400000/15.600000/69.000000/37764513.000000/2421202, Assab=-19.900000/30.500000/83.500000/73928350.700000/2424089, Astana=-47.200000/3.500000/55.100000/8452347.100000/2419355, Athens=-31.200000/19.200000/66.800000/46475271.600000/2420962, Atlanta=-29.300000/17.000000/65.200000/41216737.400000/2423678, Auckland=-32.300000/15.200000/63.700000/36820866.000000/2421246, Austin=-28.700000/20.700000/69.400000/50107005.500000/2419792, Baghdad=-35.500000/22.800000/77.300000/55097719.000000/2420096, Baguio=-30.500000/19.500000/68.800000/47196362.500000/2420376, Baku=-34.100000/15.100000/65.900000/36553830.300000/2420371, Baltimore=-34.500000/13.100000/63.600000/31712232.600000/2421740, Bamako=-23.900000/27.800000/81.400000/67279269.700000/2419877, Bangkok=-23.700000/28.600000/77.000000/69185511.700000/2419268, Bangui=-24.200000/26.000000/79.300000/62989108.200000/2422619, Banjul=-23.100000/26.000000/77.900000/62956014.400000/2420776, Barcelona=-31.000000/18.200000/67.400000/44131840.300000/2423587, Bata=-25.100000/25.100000/75.200000/60797855.100000/2423339, Batumi=-32.900000/14.000000/64.800000/33888958.900000/2420792, Beijing=-40.000000/12.900000/60.100000/31202109.900000/2419585, Beirut=-28.300000/20.900000/72.300000/50664280.300000/2423202, Belgrade=-41.800000/12.500000/67.400000/30287968.300000/2422615, Belize City=-23.800000/26.700000/77.500000/64698006.500000/2423463, Benghazi=-32.400000/19.900000/72.600000/48147631.900000/2419660, Bergen=-42.900000/7.700000/55.000000/18659014.500000/2422393, Berlin=-39.200000/10.300000/59.700000/24920944.400000/2421060, Bilbao=-36.100000/14.700000/61.800000/35568470.000000/2420710, Birao=-24.700000/26.500000/78.200000/64164219.500000/2420383, Bishkek=-43.800000/11.300000/62.200000/27388676.700000/2421024, Bissau=-20.800000/27.000000/74.100000/65316280.300000/2418995, Blantyre=-33.600000/22.200000/74.600000/53720488.400000/2420655, Bloemfontein=-35.300000/15.600000/63.200000/37797512.000000/2422928, Boise=-37.300000/11.400000/60.300000/27592519.400000/2420779, Bordeaux=-35.500000/14.200000/63.600000/34363568.000000/2421425, Bosaso=-23.900000/30.000000/82.200000/72682689.500000/2422757, Boston=-42.200000/10.900000/59.100000/26382636.300000/2420784, Bouaké=-24.700000/26.000000/74.800000/62919235.600000/2420765, Bratislava=-37.000000/10.500000/60.700000/25418842.100000/2421510, Brazzaville=-25.500000/25.000000/75.400000/60530862.300000/2422456, Bridgetown=-23.100000/27.000000/73.500000/65388887.400000/2422236, Brisbane=-28.600000/21.400000/73.500000/51842355.000000/2422585, Brussels=-38.000000/10.500000/61.600000/25403547.000000/2419325, Bucharest=-40.700000/10.800000/61.300000/26172167.600000/2420910, Budapest=-40.400000/11.300000/64.600000/27363644.100000/2420157, Bujumbura=-26.100000/23.800000/78.100000/57602274.100000/2421242, Bulawayo=-37.300000/18.900000/70.300000/45665705.700000/2417060, Burnie=-40.000000/13.100000/58.700000/31710739.600000/2420615, Busan=-37.200000/15.000000/65.500000/36290371.300000/2420822, Cabo San Lucas=-25.400000/23.900000/72.100000/57888491.000000/2421843, Cairns=-24.400000/25.000000/71.700000/60521405.400000/2420932, Cairo=-31.900000/21.400000/70.500000/51829746.000000/2421849, Calgary=-43.500000/4.400000/54.900000/10652244.800000/2418867, Canberra=-36.000000/13.100000/69.100000/31716500.100000/2423429, Cape Town=-33.400000/16.200000/65.500000/39179971.000000/2417882, Changsha=-28.500000/17.400000/67.300000/42191644.400000/2423384, Charlotte=-32.800000/16.100000/68.000000/38972135.800000/2421428, Chiang Mai=-26.300000/25.800000/75.600000/62525559.100000/2422823, Chicago=-47.000000/9.800000/61.200000/23708884.400000/2418682, Chihuahua=-31.500000/18.600000/67.400000/45044848.600000/2422035, Chittagong=-25.000000/25.900000/82.900000/62678704.700000/2420655, Chișinău=-38.300000/10.200000/58.600000/24672099.900000/2420321, Chongqing=-30.400000/18.600000/70.200000/45071353.900000/2423578, Christchurch=-45.100000/12.200000/62.400000/29513433.600000/2420755, City of San Marino=-36.800000/11.800000/61.000000/28559919.300000/2420503, Colombo=-19.800000/27.400000/76.800000/66312263.800000/2419828, Columbus=-37.300000/11.700000/61.400000/28310205.300000/2420348, Conakry=-21.900000/26.400000/87.100000/63940950.900000/2422135, Copenhagen=-43.900000/9.100000/58.400000/22084703.800000/2420900, Cotonou=-22.300000/27.200000/77.600000/65861758.700000/2420824, Cracow=-39.600000/9.300000/61.200000/22527413.900000/2421343, Da Lat=-31.100000/17.900000/71.500000/43332755.900000/2419660, Da Nang=-21.700000/25.800000/72.800000/62442860.300000/2419822, Dakar=-24.400000/24.000000/71.400000/58156215.000000/2423977, Dallas=-34.600000/19.000000/69.500000/45970823.400000/2420570, Damascus=-33.300000/17.000000/68.300000/41210932.600000/2423147, Dampier=-26.800000/26.400000/75.600000/63918953.700000/2421107, Dar es Salaam=-29.200000/25.800000/73.400000/62417294.100000/2420063, Darwin=-19.700000/27.600000/76.000000/66848958.300000/2422561, Denpasar=-27.700000/23.700000/77.400000/57337640.100000/2419399, Denver=-40.900000/10.400000/59.000000/25173906.500000/2419899, Detroit=-39.100000/10.000000/58.100000/24220514.400000/2419918, Dhaka=-23.000000/25.900000/74.700000/62804084.300000/2424285, Dikson=-59.600000/-11.100000/38.600000/-26873054.000000/2420936, Dili=-26.000000/26.600000/74.500000/64366745.400000/2419705, Djibouti=-18.400000/29.900000/77.000000/72426016.100000/2422261, Dodoma=-26.400000/22.700000/73.700000/54954138.400000/2420921, Dolisie=-22.900000/24.000000/76.800000/58181078.900000/2424082, Douala=-23.000000/26.700000/77.200000/64651524.000000/2421183, Dubai=-19.400000/26.900000/76.100000/65075376.900000/2419362, Dublin=-39.100000/9.800000/61.400000/23717952.600000/2422931, Dunedin=-37.900000/11.100000/60.500000/26865831.700000/2419931, Durban=-28.300000/20.600000/76.900000/49881733.000000/2422029, Dushanbe=-41.000000/14.700000/68.500000/35634079.000000/2424496, Edinburgh=-42.900000/9.300000/62.600000/22508993.400000/2420760, Edmonton=-42.800000/4.200000/52.700000/10142301.600000/2420645, El Paso=-30.900000/18.100000/66.800000/43870557.600000/2423084, Entebbe=-27.800000/21.000000/71.400000/50922352.400000/2423460, Erbil=-31.900000/19.500000/68.400000/47282979.000000/2423821, Erzurum=-45.500000/5.100000/55.800000/12328312.800000/2421109, Fairbanks=-56.300000/-2.300000/46.500000/-5584424.900000/2423557, Fianarantsoa=-28.700000/17.900000/70.100000/43384023.000000/2423885, Flores,  Petén=-21.700000/26.400000/78.400000/63973959.100000/2423319, Frankfurt=-39.200000/10.600000/60.800000/25654189.300000/2420005, Fresno=-33.900000/17.900000/77.200000/43407468.700000/2423868, Fukuoka=-32.700000/17.000000/68.900000/41106480.200000/2417996, Gaborone=-27.600000/21.000000/71.200000/50874287.500000/2423484, Gabès=-31.300000/19.500000/67.000000/47204487.000000/2421504, Gagnoa=-23.200000/26.000000/75.200000/62984032.400000/2422350, Gangtok=-39.300000/15.200000/68.500000/36830181.800000/2423465, Garissa=-17.700000/29.300000/81.400000/70926165.100000/2421116, Garoua=-21.200000/28.300000/80.300000/68480658.900000/2419119, George Town=-20.600000/27.900000/77.000000/67526190.500000/2421302, Ghanzi=-25.500000/21.400000/68.700000/51793532.800000/2419575, Gjoa Haven=-66.600000/-14.400000/37.000000/-34858358.400000/2420830, Guadalajara=-29.600000/20.900000/68.600000/50646057.600000/2421662, Guangzhou=-30.900000/22.400000/70.900000/54198937.500000/2419679, Guatemala City=-28.500000/20.400000/69.100000/49398383.900000/2420545, Halifax=-39.500000/7.500000/57.700000/18155426.200000/2420412, Hamburg=-40.100000/9.700000/59.800000/23464279.200000/2418841, Hamilton=-45.600000/13.800000/66.800000/33408642.600000/2420616, Hanga Roa=-29.200000/20.500000/69.400000/49644520.200000/2421247, Hanoi=-25.900000/23.600000/75.300000/57100427.700000/2419878, Harare=-30.200000/18.400000/73.600000/44540978.300000/2420616, Harbin=-45.700000/5.000000/54.700000/12087701.400000/2420045, Hargeisa=-27.000000/21.700000/72.300000/52559589.400000/2422999, Hat Yai=-26.400000/27.000000/77.900000/65337695.900000/2419477, Havana=-22.700000/25.200000/77.300000/61010863.300000/2420665, Helsinki=-42.600000/5.900000/58.700000/14268434.100000/2419414, Heraklion=-34.500000/18.900000/69.000000/45772037.900000/2422372, Hiroshima=-32.300000/16.300000/68.600000/39507122.000000/2424731, Ho Chi Minh City=-22.000000/27.400000/84.100000/66339922.700000/2421754, Hobart=-35.400000/12.700000/62.000000/30738605.600000/2421516, Hong Kong=-23.600000/23.300000/74.400000/56385469.800000/2420935, Honiara=-20.800000/26.500000/77.300000/64204665.800000/2422411, Honolulu=-22.700000/25.400000/75.000000/61498033.100000/2421103, Houston=-29.700000/20.800000/76.200000/50351117.800000/2420535, Ifrane=-36.600000/11.400000/63.900000/27552219.100000/2419816, Indianapolis=-41.100000/11.800000/60.400000/28589823.400000/2424001, Iqaluit=-59.500000/-9.300000/43.100000/-22479290.000000/2420693, Irkutsk=-48.000000/1.000000/51.800000/2439872.800000/2422548, Istanbul=-40.800000/13.900000/65.000000/33684377.600000/2422552, Jacksonville=-35.400000/20.300000/68.900000/49110505.300000/2418971, Jakarta=-25.400000/26.700000/75.500000/64623538.800000/2421150, Jayapura=-19.600000/27.000000/75.400000/65278945.400000/2419349, Jerusalem=-29.200000/18.300000/67.600000/44324154.600000/2421773, Johannesburg=-33.800000/15.500000/68.700000/37573142.800000/2423196, Jos=-26.100000/22.800000/73.100000/55177749.200000/2419831, Juba=-21.600000/27.800000/82.300000/67316111.000000/2421699, Kabul=-36.400000/12.100000/66.100000/29294574.900000/2421654, Kampala=-29.200000/20.000000/71.200000/48420683.200000/2420839, Kandi=-20.300000/27.700000/78.800000/67120549.300000/2423252, Kankan=-22.300000/26.500000/82.900000/64074173.000000/2418967, Kano=-28.700000/26.400000/77.300000/63905296.500000/2420682, Kansas City=-36.100000/12.500000/60.000000/30302767.900000/2425031, Karachi=-23.500000/26.000000/76.600000/63008711.700000/2423138, Karonga=-25.700000/24.400000/73.000000/59138857.600000/2422737, Kathmandu=-30.300000/18.300000/66.700000/44259502.400000/2418619, Khartoum=-18.700000/29.900000/80.000000/72296585.000000/2417785, Kingston=-20.400000/27.400000/77.400000/66345591.000000/2421857, Kinshasa=-21.400000/25.300000/73.100000/61225714.000000/2420205, Kolkata=-22.100000/26.700000/75.200000/64678054.100000/2422057, Kuala Lumpur=-20.500000/27.300000/76.100000/66094099.500000/2421133, Kumasi=-22.700000/26.000000/75.400000/63029444.200000/2423862, Kunming=-31.800000/15.700000/67.800000/38031033.800000/2420918, Kuopio=-47.600000/3.400000/53.200000/8235215.400000/2421896, Kuwait City=-23.400000/25.700000/79.200000/62239846.200000/2421325, Kyiv=-42.700000/8.400000/58.300000/20371176.500000/2422751, Kyoto=-34.400000/15.800000/62.500000/38250407.700000/2420731, La Ceiba=-26.400000/26.200000/77.200000/63358112.900000/2418828, La Paz=-31.900000/23.700000/72.300000/57266598.300000/2417527, Lagos=-21.700000/26.800000/77.700000/64902086.800000/2421712, Lahore=-31.900000/24.300000/73.500000/58797599.700000/2421023, Lake Havasu City=-31.700000/23.700000/74.100000/57414181.200000/2421334, Lake Tekapo=-37.600000/8.700000/59.600000/21059016.200000/2421471, Las Palmas de Gran Canaria=-28.300000/21.200000/68.300000/51302644.000000/2418789, Las Vegas=-28.600000/20.300000/70.100000/49157193.600000/2421978, Launceston=-40.400000/13.100000/60.100000/31747234.300000/2422154, Lhasa=-42.000000/7.600000/64.000000/18404390.500000/2423255, Libreville=-22.000000/25.900000/71.400000/62780919.800000/2423941, Lisbon=-33.900000/17.500000/64.000000/42413952.900000/2423349, Livingstone=-26.200000/21.800000/73.900000/52768006.900000/2419981, Ljubljana=-39.300000/10.900000/59.000000/26389211.000000/2421695, Lodwar=-17.600000/29.300000/79.000000/70949509.700000/2422004, Lomé=-24.300000/26.900000/75.900000/65097792.000000/2419999, London=-46.500000/11.300000/60.200000/27313388.100000/2419566, Los Angeles=-35.900000/18.600000/67.100000/45039393.300000/2423425, Louisville=-39.300000/13.900000/63.200000/33604772.600000/2420938, Luanda=-23.300000/25.800000/77.100000/62455810.300000/2420248, Lubumbashi=-30.500000/20.800000/69.700000/50427758.400000/2423162, Lusaka=-28.600000/19.900000/74.800000/48153862.400000/2420619, Luxembourg City=-43.200000/9.300000/57.200000/22508071.000000/2418950, Lviv=-48.600000/7.800000/57.600000/18901296.600000/2421933, Lyon=-43.900000/12.500000/60.900000/30280665.300000/2421974, Madrid=-37.200000/15.000000/65.500000/36283962.800000/2419542, Mahajanga=-25.400000/26.300000/77.600000/63621566.300000/2419258, Makassar=-27.500000/26.700000/78.600000/64682178.900000/2421672, Makurdi=-21.200000/26.000000/73.700000/62971664.500000/2420329, Malabo=-21.900000/26.300000/79.900000/63661142.500000/2420207, Malé=-24.800000/28.000000/75.900000/67751733.100000/2419965, Managua=-22.400000/27.300000/75.800000/66126129.700000/2421864, Manama=-23.900000/26.500000/79.600000/64158666.900000/2421224, Mandalay=-24.800000/28.000000/79.300000/67790223.300000/2420815, Mango=-21.000000/28.100000/79.000000/68025116.900000/2420597, Manila=-26.100000/28.400000/83.600000/68734661.000000/2420025, Maputo=-28.500000/22.800000/73.800000/55208279.200000/2421789, Marrakesh=-31.400000/19.600000/79.700000/47410582.700000/2420898, Marseille=-39.500000/15.800000/64.100000/38234977.400000/2419817, Maun=-28.300000/22.400000/70.600000/54261452.200000/2421376, Medan=-22.700000/26.500000/80.300000/64230835.300000/2423864, Mek'ele=-27.900000/22.700000/71.000000/54933438.100000/2419234, Melbourne=-39.000000/15.100000/63.700000/36548823.000000/2421966, Memphis=-33.500000/17.200000/66.500000/41621688.300000/2420771, Mexicali=-26.300000/23.100000/76.800000/55935054.200000/2421165, Mexico City=-32.800000/17.500000/67.000000/42346495.200000/2418762, Miami=-21.300000/24.900000/77.900000/60329439.800000/2421333, Milan=-42.400000/13.000000/63.200000/31521296.400000/2423003, Milwaukee=-39.500000/8.900000/57.200000/21569257.700000/2420578, Minneapolis=-46.200000/7.800000/59.700000/18874607.000000/2418438, Minsk=-47.700000/6.700000/55.800000/16232102.900000/2419284, Mogadishu=-24.200000/27.100000/81.700000/65612952.700000/2420364, Mombasa=-22.600000/26.300000/75.600000/63586140.900000/2417781, Monaco=-32.100000/16.400000/65.800000/39662388.900000/2420168, Moncton=-45.500000/6.100000/57.400000/14779553.500000/2421830, Monterrey=-27.500000/22.300000/75.500000/53934288.900000/2418695, Montreal=-42.500000/6.800000/58.200000/16476715.100000/2422708, Moscow=-43.700000/5.800000/55.800000/14035584.900000/2422203, Mumbai=-25.700000/27.100000/76.000000/65677865.900000/2423433, Murmansk=-50.000000/0.600000/47.400000/1456919.900000/2420107, Muscat=-23.000000/28.000000/76.300000/67764471.200000/2419411, Mzuzu=-31.000000/17.700000/67.000000/42863238.400000/2421472, N'Djamena=-20.400000/28.300000/83.600000/68528484.900000/2421672, Naha=-26.100000/23.100000/74.600000/55963630.200000/2422633, Nairobi=-32.700000/17.800000/68.000000/43125053.600000/2422505, Nakhon Ratchasima=-24.100000/27.300000/80.700000/66088313.700000/2420671, Napier=-36.400000/14.600000/62.300000/35328939.900000/2421229, Napoli=-32.000000/15.900000/64.400000/38495425.100000/2422523, Nashville=-40.300000/15.400000/67.000000/37279010.600000/2420499, Nassau=-28.100000/24.600000/78.000000/59601396.100000/2422108, Ndola=-30.000000/20.300000/69.500000/49121866.000000/2419276, New Delhi=-28.600000/25.000000/76.000000/60520573.900000/2420424, New Orleans=-29.200000/20.700000/76.300000/50165086.200000/2423202, New York City=-38.800000/12.900000/61.300000/31269632.000000/2423010, Ngaoundéré=-31.100000/22.000000/70.400000/53271047.500000/2421729, Niamey=-20.400000/29.300000/82.800000/70908293.700000/2420377, Nicosia=-33.800000/19.700000/67.600000/47701044.000000/2422096, Niigata=-35.700000/13.900000/62.100000/33652701.700000/2421237, Nouadhibou=-28.300000/21.300000/73.700000/51620990.900000/2423808, Nouakchott=-27.000000/25.700000/75.500000/62202112.500000/2420204, Novosibirsk=-52.600000/1.700000/56.000000/4083403.800000/2422351, Nuuk=-49.900000/-1.400000/50.800000/-3358732.500000/2421065, Odesa=-37.300000/10.700000/57.900000/25885304.100000/2421905, Odienné=-23.400000/26.000000/77.400000/63031658.400000/2423799, Oklahoma City=-34.800000/15.900000/64.300000/38489557.000000/2420633, Omaha=-39.300000/10.600000/62.700000/25645417.800000/2420343, Oranjestad=-19.100000/28.100000/78.200000/68020338.100000/2421236, Oslo=-46.100000/5.700000/58.900000/13791313.500000/2420236, Ottawa=-46.700000/6.600000/55.100000/16000071.900000/2423837, Ouagadougou=-24.300000/28.300000/78.400000/68601577.800000/2423325, Ouahigouya=-21.500000/28.600000/76.100000/69185798.400000/2418834, Ouarzazate=-31.500000/18.900000/71.700000/45756310.700000/2420693, Oulu=-48.900000/2.700000/52.500000/6513070.900000/2416092, Palembang=-23.500000/27.300000/80.800000/66169607.900000/2423369, Palermo=-27.900000/18.500000/70.200000/44722216.800000/2418231, Palm Springs=-25.300000/24.500000/78.300000/59315400.000000/2420562, Palmerston North=-36.000000/13.200000/64.300000/32002821.500000/2424433, Panama City=-22.400000/28.000000/76.300000/67774859.900000/2419422, Parakou=-28.100000/26.800000/76.900000/64846620.700000/2419343, Paris=-39.200000/12.300000/65.900000/29777234.200000/2419708, Perth=-29.800000/18.700000/66.300000/45249459.500000/2421118, Petropavlovsk-Kamchatsky=-49.800000/1.900000/49.300000/4634401.300000/2420884, Philadelphia=-35.600000/13.200000/60.400000/31967205.800000/2422337, Phnom Penh=-22.500000/28.300000/81.600000/68471884.300000/2419452, Phoenix=-24.000000/23.900000/74.100000/57832303.700000/2419760, Pittsburgh=-37.500000/10.800000/59.800000/26146838.100000/2422434, Podgorica=-35.900000/15.300000/65.400000/37066195.900000/2422159, Pointe-Noire=-22.400000/26.100000/72.100000/63278330.000000/2424513, Pontianak=-29.800000/27.700000/79.800000/67106641.900000/2422453, Port Moresby=-22.400000/26.900000/72.700000/65108318.700000/2420011, Port Sudan=-20.300000/28.400000/79.800000/68765742.400000/2421003, Port Vila=-22.500000/24.300000/75.100000/58894486.700000/2424465, Port-Gentil=-26.900000/26.000000/77.700000/62994709.900000/2423066, Portland (OR)=-39.000000/12.400000/62.600000/30061008.500000/2422766, Porto=-31.200000/15.700000/63.200000/38017795.800000/2420703, Prague=-42.600000/8.400000/61.000000/20335934.300000/2420977, Praia=-26.100000/24.400000/70.900000/59117951.100000/2422780, Pretoria=-28.900000/18.200000/67.500000/44054117.900000/2422945, Pyongyang=-38.200000/10.800000/64.000000/26136288.900000/2420498, Rabat=-30.000000/17.200000/64.500000/41635189.500000/2421143, Rangpur=-24.200000/24.400000/72.200000/59074712.600000/2420987, Reggane=-27.100000/28.300000/75.000000/68462826.400000/2419685, Reykjavík=-42.800000/4.300000/52.500000/10430167.000000/2421465, Riga=-43.500000/6.200000/54.100000/15015325.100000/2422935, Riyadh=-24.100000/26.000000/75.300000/62954557.700000/2420906, Rome=-37.100000/15.200000/62.900000/36785427.600000/2420978, Roseau=-24.400000/26.200000/76.300000/63433606.100000/2420485, Rostov-on-Don=-40.200000/9.900000/60.300000/23960168.400000/2421118, Sacramento=-31.800000/16.300000/65.600000/39470782.200000/2421690, Saint Petersburg=-45.400000/5.800000/57.100000/14039389.900000/2421542, Saint-Pierre=-45.600000/5.700000/55.500000/13803553.000000/2419366, Salt Lake City=-39.400000/11.600000/67.600000/28080857.800000/2417275, San Antonio=-30.400000/20.800000/68.800000/50405884.700000/2423684, San Diego=-33.700000/17.800000/66.600000/43101437.300000/2421620, San Francisco=-34.300000/14.600000/65.100000/35384729.000000/2423101, San Jose=-30.700000/16.400000/66.500000/39765213.700000/2422921, San José=-28.900000/22.600000/74.300000/54709360.500000/2421030, San Juan=-21.400000/27.200000/77.600000/65878152.600000/2422335, San Salvador=-27.600000/23.100000/78.600000/55924343.500000/2420806, Sana'a=-27.800000/20.000000/67.800000/48374521.500000/2420942, Santo Domingo=-23.300000/25.900000/78.600000/62697380.700000/2421069, Sapporo=-45.200000/8.900000/64.600000/21556418.300000/2421163, Sarajevo=-37.600000/10.100000/56.900000/24482417.400000/2422492, Saskatoon=-52.400000/3.300000/50.700000/7965913.300000/2420239, Seattle=-42.500000/11.300000/64.100000/27327803.900000/2421876, Seoul=-35.300000/12.500000/66.700000/30280325.700000/2422508, Seville=-30.900000/19.200000/76.700000/46533179.800000/2423953, Shanghai=-38.500000/16.700000/68.000000/40501128.500000/2424240, Singapore=-27.100000/27.000000/79.200000/65436967.100000/2423241, Skopje=-33.800000/12.400000/62.700000/30066758.500000/2424526, Sochi=-40.500000/14.200000/69.100000/34400894.500000/2423275, Sofia=-38.700000/10.600000/61.600000/25660881.300000/2421146, Sokoto=-25.700000/28.000000/74.400000/67732787.200000/2419571, Split=-42.300000/16.100000/64.100000/39009240.800000/2422182, St. John's=-44.900000/5.000000/56.800000/12116135.100000/2422249, St. Louis=-34.500000/13.900000/66.100000/33641974.900000/2420050, Stockholm=-44.200000/6.600000/54.500000/15985651.100000/2421767, Surabaya=-26.500000/27.100000/75.000000/65673807.200000/2422374, Suva=-25.000000/25.600000/74.900000/61956851.600000/2419423, Suwałki=-41.400000/7.200000/59.200000/17408982.200000/2420355, Sydney=-34.800000/17.700000/73.400000/42888682.100000/2421919, Ségou=-26.100000/28.000000/79.400000/67852563.900000/2422850, Tabora=-26.400000/23.000000/72.900000/55641415.300000/2420202, Tabriz=-37.300000/12.600000/62.800000/30517319.900000/2422107, Taipei=-29.600000/23.000000/70.700000/55735804.200000/2422621, Tallinn=-42.800000/6.400000/55.200000/15479650.100000/2421794, Tamale=-22.300000/27.900000/77.400000/67594077.600000/2421813, Tamanrasset=-32.100000/21.700000/69.800000/52600015.100000/2425160, Tampa=-28.800000/22.900000/74.500000/55409874.800000/2420314, Tashkent=-32.000000/14.800000/62.800000/35811763.400000/2420157, Tauranga=-32.800000/14.800000/64.100000/35827357.500000/2420906, Tbilisi=-38.000000/12.900000/62.700000/31188813.300000/2418769, Tegucigalpa=-27.700000/21.700000/71.300000/52470132.100000/2419121, Tehran=-32.500000/17.000000/66.500000/41120691.700000/2419733, Tel Aviv=-28.600000/20.000000/70.800000/48427593.800000/2420871, Thessaloniki=-34.900000/16.000000/63.200000/38766355.200000/2422204, Thiès=-24.300000/24.000000/77.900000/58052104.500000/2419341, Tijuana=-31.100000/17.800000/69.700000/43104502.900000/2420597, Timbuktu=-23.200000/28.000000/75.300000/67807967.400000/2422700, Tirana=-35.400000/15.200000/65.300000/36831176.900000/2420675, Toamasina=-29.200000/23.400000/75.400000/56651405.800000/2421395, Tokyo=-47.100000/15.400000/64.600000/37272159.600000/2420903, Toliara=-26.400000/24.100000/75.200000/58411928.200000/2424256, Toluca=-37.100000/12.400000/64.800000/30003066.100000/2421911, Toronto=-41.400000/9.400000/57.600000/22744511.400000/2422254, Tripoli=-29.700000/20.000000/66.600000/48394214.300000/2419629, Tromsø=-51.200000/2.900000/51.000000/7044946.800000/2422735, Tucson=-33.300000/20.900000/73.400000/50600185.700000/2423065, Tunis=-30.700000/18.400000/72.500000/44540324.100000/2420620, Ulaanbaatar=-49.700000/-0.400000/58.700000/-975550.900000/2418037, Upington=-30.100000/20.400000/71.100000/49409204.900000/2421983, Vaduz=-38.700000/10.100000/59.500000/24441467.900000/2422326, Valencia=-35.000000/18.300000/69.600000/44317168.800000/2422966, Valletta=-31.100000/18.800000/68.900000/45544153.400000/2423296, Vancouver=-39.900000/10.400000/58.800000/25144174.300000/2419853, Veracruz=-23.900000/25.400000/76.300000/61523748.900000/2421734, Vienna=-36.800000/10.400000/59.400000/25175903.100000/2420109, Vientiane=-29.900000/25.900000/77.500000/62678014.500000/2419063, Villahermosa=-29.600000/27.100000/79.600000/65726534.600000/2424879, Vilnius=-41.500000/6.000000/56.400000/14519063.000000/2418316, Virginia Beach=-35.500000/15.800000/65.800000/38215503.000000/2419627, Vladivostok=-43.000000/4.900000/51.900000/11829391.100000/2422629, Warsaw=-38.500000/8.500000/59.400000/20577117.000000/2419398, Washington, D.C.=-34.600000/14.600000/68.600000/35352392.000000/2422138, Wau=-22.200000/27.800000/75.200000/67388726.400000/2423457, Wellington=-35.700000/12.900000/59.800000/31281809.800000/2423584, Whitehorse=-51.700000/-0.100000/50.900000/-245386.300000/2422356, Wichita=-34.900000/13.900000/61.700000/33685323.300000/2421905, Willemstad=-26.600000/28.000000/83.400000/67757194.900000/2420352, Winnipeg=-44.200000/3.000000/55.500000/7273329.600000/2420760, Wrocław=-37.000000/9.600000/58.600000/23223051.400000/2420545, Xi'an=-38.100000/14.100000/62.200000/34144925.900000/2421557, Yakutsk=-57.300000/-8.800000/40.200000/-21303747.400000/2421317, Yangon=-24.800000/27.500000/77.800000/66518544.100000/2419385, Yaoundé=-26.300000/23.800000/75.200000/57631436.600000/2421572, Yellowknife=-54.800000/-4.300000/50.300000/-10391369.900000/2418327, Yerevan=-34.700000/12.400000/58.900000/30061074.700000/2423248, Yinchuan=-46.500000/9.000000/56.400000/21800931.000000/2423242, Zagreb=-40.300000/10.700000/60.700000/25910157.100000/2420365, Zanzibar City=-27.100000/26.000000/76.000000/63039557.000000/2424492, Zürich=-41.700000/9.300000/58.400000/22490342.700000/2418586, Ürümqi=-39.100000/7.400000/56.600000/17931401.500000/2422812, İzmir=-31.800000/17.900000/73.000000/43307823.000000/2421147}";

    // gunnar's baseline
    // best = 110,302ms

    // Gunnar baseline: 110,302
    // First          : 109,389             (mmap & offHeap access)
    // Second         :  52,745             (custom parse double)
    // Third          :  38,996             (incremental hash ++)
    // Fourth         :  8,002  (4,803*)    (multi-threaded, * = spurious improvement due to printf, needs explaining)

    /**
     * utility class for rough & ready timing
     */
    public static class Timer {
        private long start;
        private long end;

        public Timer() {
            start();
        }

        public void start() {
            start = System.nanoTime();
        }

        public void end() {
            end = System.nanoTime();
        }

        @Override
        public String toString() {
            end();
            return "%d ms".formatted(TimeUnit.NANOSECONDS.toMillis(end - start));
        }
    }

    /**
     * Second, rewrite the Double parsing logic to avoid creating garbage or using the build in Java methods
     */
    @SuppressWarnings("preview")
    private static class Worker implements Callable<Map<Worker.StationStat, Worker.StationStat>> {

        public static class StationStat {
            byte[] bytes;
            int length;
            int hash;

            double min = Double.MAX_VALUE;
            double max = Double.MIN_VALUE;
            int count = 0;
            double sum = 0;
            String name;
            String summaryString = null;

            public StationStat() {
                // constructor only used once to create a resusable template that can hold any city name
                this.bytes = new byte[100];
            }

            /**
             * Copy constructor, populate a new instance from a template
             *
             * @param template pre-populated with the bytes of a city name and the corresponding hash code
             */
            @SuppressWarnings("CopyConstructorMissesField")
            public StationStat(StationStat template) {
                this.bytes = Arrays.copyOf(template.bytes, template.bytes.length);
                this.length = template.length;
                this.hash = template.hash;
            }

            /**
             * @param measurement update this city with a new measurement
             */
            public void add(double measurement) {
                count++;
                sum += measurement;
                // possible opt, JITwatch suggests we're not inlining
                min = Math.min(min, measurement);
                max = Math.max(max, measurement);
            }

            /**
             * if one has not already been cached, create a String representation of the station name
             * @return the station name
             */
            private String getStationName() {
                if (name == null) {
                    name = new String(bytes, 0, length, StandardCharsets.UTF_8);
                }
                return name;
            }

            @Override
            public boolean equals(Object o) {
                if (o instanceof StationStat stationStat && length == stationStat.length) {
                    return Arrays.mismatch(bytes, 0, length, stationStat.bytes, 0, length) < 0;
                }

                return false;
            }

            @Override
            public int hashCode() {
                return hash;
            }

            /**
             * Gunnar's rounding for consistency
             * @param value value to be rounded to 1.dp
             * @return rounded value
             */
            private double round(double value) {
                return Math.round(value * 10.0) / 10.0;
            }

            @Override
            public String toString() {
                double mean = (Math.round(sum * 10.0) / 10.0) / count;

                if (DEBUG) {
                    return "%s=%f/%f/%f/%f/%d".formatted(getStationName(), round(min), round(mean), round(max), round(sum), count);
                }

                if (summaryString == null) {
                    summaryString = "%s=%.1f/%.1f/%.1f".formatted(getStationName(), round(min), round(mean), round(max));     // (Math.round(agg.sum * 10.0) / 10.0) / agg.count
                }
                return summaryString;
            }
        }

        public static final ValueLayout.OfLong LONG_UNALIGNED_BE = JAVA_LONG.withOrder(BIG_ENDIAN).withByteAlignment(1);
        public static final long LONG_MASK_MINUS_FIRST_BYTE = (long) '-' << (7 * 8);

        private final Map<StationStat, StationStat> stats;
        private final MemorySegment source;

        private final long maxOffset;

        private long sourceOffset;

        public Worker(MemorySegment source, long startingOffset, long maxOffset) {
            this.source = source;
            this.sourceOffset = startingOffset;
            this.maxOffset = maxOffset;
            this.stats = HashMap.newHashMap(NUMBER_OF_STATIONS);
        }

        @Override
        public Map<StationStat, StationStat> call() {

            try {
                if (sourceOffset != 0 && source.get(JAVA_BYTE, sourceOffset - 1) != (byte) '\n') {
                    // we're aligned to the start of a city name '\n', find the next one and start from there
                    while (source.get(JAVA_BYTE, sourceOffset) != (byte) '\n') {
                        sourceOffset++;
                    }
                    sourceOffset++;
                }

                byte lastChar;
                StationStat template = new StationStat();
                int length = 0;
                int hash = 0;

                while (true) {
                    lastChar = source.get(JAVA_BYTE, sourceOffset++);

                    template.bytes[length++] = lastChar;
                    // incrementally calculate the hash code
                    hash = 31 * hash + lastChar;

                    if (lastChar == ';') {
                        // the ';' is not part of the name
                        template.length = --length;
                        template.hash = hash;

                        // somewhat astonishingly the following  works:
                        // StationStat stationStat = stats.computeIfAbsent(template, StationStat::new);
                        // even though all values will share the same key object - and it's faster...
                        //
                        // I suspect the buckets are sparsely populated and every element in the bucket would need an equals
                        // comparison anyway - however it's likely all hell will break loose on a resize
                        StationStat stationStat = stats.get(template);
                        if (stationStat == null) {
                            stationStat = new StationStat(template);
                            stats.put(stationStat, stationStat);
                        }

                        // advances sourceOffset to first byte of next city name
                        double measurement = extractMeasurement(source);
                        stationStat.add(measurement);

                        if (sourceOffset >= maxOffset) {
                            break;
                        }

                        length = 0;
                        hash = 0;
                    }
                }
            } catch (Exception e) {
                System.err.println("failied: " + e);
                throw new RuntimeException(e);
            }

            return stats;
        }

        /**
         * All measurements fit within a single long, rather than read bytes individually read the long then bit-shift
         * and mask to identify the '-' and '.'.
         * <p>
         * Allowable specialisations based upon source data:
         * - first char must be a '-' or a number
         * - all numbers have a '.'
         * - one number always follows the '.'
         *
         * @param source source buffer
         * @return the parsed double
         */
        private double extractMeasurement(MemorySegment source) {

            // the very last measurement in the file may not fit into a long without busting the MemorySegment size, as
            // it's a one off at the very end, we take the hit of doing it the easy way
            if (sourceOffset + 8 >= source.byteSize()) {
                long length = source.byteSize() - sourceOffset - 1;
                String finalMeasurement = new String(source.asSlice(sourceOffset, length).toArray(JAVA_BYTE), StandardCharsets.UTF_8);
                sourceOffset += length + 1;
                return Double.parseDouble(finalMeasurement);
            }

            int accumulator = 0;
            double doubleValue;
            int byteOffsetInLong = 7;   // read left to right

            long measurementBytes = source.get(LONG_UNALIGNED_BE, sourceOffset);

            boolean isNegative = (measurementBytes & LONG_MASK_MINUS_FIRST_BYTE) == LONG_MASK_MINUS_FIRST_BYTE;
            if (isNegative) {
                // make a note and skip to next byte in the measurement
                byteOffsetInLong--;
            }

            // could unroll this loop given there are only a handful of possibilities where the decimal place can be.
            // Lower hanging fruit remains available
            while (true) {

                // get next byte in the measurement string
                byte measurementByte = (byte) ((measurementBytes >> (8 * (byteOffsetInLong))) & 0x7F);

                // all measurements are to 1 decimal place so we can finalise and stop once the decimal place is found
                if (measurementByte == '.') {
                    byte lastByte = (byte) (measurementBytes >> 8 * (byteOffsetInLong - 1) & 0x7F);
                    lastByte -= '0';
                    doubleValue = accumulator;
                    doubleValue += (lastByte / 10.0);

                    // advance sourceOffset by the integer component + 3 bytes for '.' + 'number' + '\n'
                    sourceOffset += (7 + 3) - byteOffsetInLong;

                    if (isNegative) {
                        doubleValue = -doubleValue;
                    }

                    return doubleValue;
                } else {
                    // otherwise accumulate the integer components
                    accumulator *= 10;
                    accumulator += measurementByte - '0';
                }

                byteOffsetInLong--;
            }
        }
    }

    void main() {
        Timer timer = new Timer();

        ExecutorService threadPool = Executors.newFixedThreadPool(THREAD_COUNT);

        Arena offHeap = Arena.global();

        try (FileChannel channel = FileChannel.open(Path.of("D:\\development\\workspace\\1brc\\measurements.txt"), StandardOpenOption.READ)) {

            MemorySegment source = channel.map(FileChannel.MapMode.READ_ONLY, 0, channel.size(), offHeap);

            long totalBytes = source.byteSize();
            long segmentSize = totalBytes / THREAD_COUNT;
            long startingOffset = 0;

            List<Worker> workers = new ArrayList<>(THREAD_COUNT);

            for (int i = 0; i < THREAD_COUNT-1; i++) {
                System.out.printf("");      // TODO just nudging stdout in this loop can shave ~3ms off the runtime!
                long maxOffset = startingOffset + segmentSize;
                workers.add(new Worker(source, startingOffset, maxOffset));
                startingOffset += segmentSize;
            }

            // add the final worker
            workers.add(new Worker(source, startingOffset, totalBytes));

            List<Future<Map<Worker.StationStat, Worker.StationStat>>> futures = threadPool.invokeAll(workers);

            String result = produceResults(futures);

            System.out.println(result);

            // complete - print elapsed time
            System.out.printf("\n%s%n", timer);

            // validity checks
            if (DEBUG) {
                if (!result.equals(DEBUG_OUTPUT)) {
                    System.err.println("expected: " + DEBUG_OUTPUT);
                    System.err.println("actual  : " + result);
                }
            } else {
                if (!result.equals(GUNNAR_OUTPUT)) {
                    System.out.println("first=expected");
                    System.err.println("expected: " + GUNNAR_OUTPUT);
                    System.err.println("actual  : " + result);
                }
            }
        } catch (IOException | InterruptedException e) {
            throw new RuntimeException(e);
        }

        // terminate fast
        Runtime.getRuntime().halt(0);
    }

    private static String produceResults(List<Future<Map<Worker.StationStat, Worker.StationStat>>> futures) {
        Map<Worker.StationStat, Worker.StationStat> consolidatedResults = futures.stream()
                .map(CalculateAverage_rjk::uncheckedGet)
                .map(Map::entrySet)
                .flatMap(Collection::stream)
                .collect(Collectors.toMap(
                        Map.Entry::getKey,
                        Map.Entry::getValue,
                        (value1, value2) -> {
                            value1.count += value2.count;
                            value1.sum += value2.sum;
                            value1.min = Math.min(value1.min, value2.min);
                            value1.max = Math.max(value1.max, value2.max);

                            value1.getStationName();

                            return value1;
                        }));

        //noinspection StringTemplateMigration
        return "{" +
                consolidatedResults.values()
                        .stream()
                        .sorted(Comparator.comparing(Worker.StationStat::getStationName))
                        .map(Worker.StationStat::toString)
                        .collect(Collectors.joining(", "))
                + "}";
    }

    private static <T> T uncheckedGet(Future<T> future) {
        try {
            return future.get();
        } catch (InterruptedException | ExecutionException e) {
            throw new RuntimeException(e);
        }
    }
}
